#!/bin/bash

# === GPIO å¼•è„šå®šä¹‰ï¼ˆæ ¹æ®ä½ çš„ usb2gpio.pyï¼‰===
DATA=1
WR=2
CS=3

echo "ğŸ”§ åˆå§‹åŒ–å¼•è„š..."
./usb2gpio.py set $CS 1   # CS é»˜è®¤é«˜
./usb2gpio.py set $WR 0   # WR åˆå§‹ä½ï¼ˆä¸ºä¸‹é™æ²¿åšå‡†å¤‡ï¼‰
./usb2gpio.py set $DATA 0
sleep 0.1

# === å‘é€å¸§ï¼ˆä¸‹é™æ²¿é‡‡æ ·ï¼HT1621 å®˜æ–¹è¦æ±‚ï¼‰===
send_frame() {
    local frame="$1"
    ./usb2gpio.py set $CS 0          # æ‹‰ä½ CSï¼Œå¼€å§‹ä¼ è¾“
    for ((i=0; i<${#frame}; i++)); do
        ./usb2gpio.py set $DATA ${frame:$i:1}
        ./usb2gpio.py set $WR 0      # ğŸ‘ˆ ä¸‹é™æ²¿ï¼HT1621 åœ¨æ­¤åˆ»é‡‡æ ·
        ./usb2gpio.py set $WR 1      # æ‹‰é«˜ WR
    done
    ./usb2gpio.py set $CS 1          # æ‹‰é«˜ CSï¼Œç»“æŸå¹¶åº”ç”¨
    sleep 0.01
}

# === å‘å‘½ä»¤ï¼š100 + 9-bit ===
send_cmd() {
    local cmd9="$1"
    [[ ${#cmd9} -eq 9 ]] || { echo "âŒ å‘½ä»¤éœ€9ä½"; exit 1; }
    send_frame "100${cmd9}"
}

# === å†™ RAMï¼š101 + 6-bit åœ°å€ + 8-bit æ•°æ® ===
write_ram_bin() {
    local addr=$1
    local data8="$2"
    [[ ${#data8} -eq 8 && $data8 =~ ^[01]+$ ]] || { echo "âŒ æ•°æ®éœ€8ä½äºŒè¿›åˆ¶"; exit 1; }

    # åœ°å€è½¬6ä½äºŒè¿›åˆ¶ï¼ˆ0~63ï¼‰
    local addr_bin=$(printf "%06d" "$(echo "obase=2; $addr" | bc 2>/dev/null || echo "0")")
    [[ ${#addr_bin} -le 6 ]] || addr_bin="000000"

    send_frame "101${addr_bin}${data8}"
}

# ==================================================
# STEP 1: åˆå§‹åŒ– HT1621ï¼ˆä¸¥æ ¼æŒ‰ä½ çš„åºåˆ—ï¼‰
# ==================================================
echo -e "\nâœ… åˆå§‹åŒ– HT1621ï¼ˆå…±é˜´ï¼Œ6ä½æ•°ç ç®¡ï¼‰"
send_cmd "000000000"   # SYSDIS
sleep 0.01
send_cmd "001010110"   # BIAS: 1/3, 4 COM
send_cmd "011000000"   # RC256
send_cmd "000000010"   # SYSEN
send_cmd "000000110"   # LCDON
sleep 0.1

# ==================================================
# STEP 2: æ˜¾ç¤º "123456"ï¼ˆä½¿ç”¨ä½ æä¾›çš„æ®µç ï¼‰
# ==================================================
echo -e "\nğŸ’¡ æ˜¾ç¤º '123456'ï¼ˆæŒ‰ä½ çš„æ®µç è¡¨ï¼‰"

# å…±é˜´ï¼š1 = äº® â†’ å…¨äº® = 11111111
write_ram_bin 0  "01100011"   # æœ€å·¦ä½ #æœ€ä¸Šå³ä¸‹ç‚¹äº®
write_ram_bin 2  "01100000"   # å·¦ä¸Šå·¦ä¸‹å³ä¸‹ç‚¹äº®
write_ram_bin 4  "01011011"   # å·¦ä¸Šå·¦ä¸‹ç‚¹äº®
write_ram_bin 6  "01100011"   # åªæœ‰å·¦ä¸‹æ²¡ç‚¹äº®
write_ram_bin 8  "01100000"   # å·¦ä¸Šå·¦ä¸‹ç‚¹äº®
write_ram_bin 10 "01100000"   # æœ€å³ä½


echo "âœ… æ˜¾ç¤ºå®Œæˆï¼"
